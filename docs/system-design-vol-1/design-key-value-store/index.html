<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-system-design-vol-1/design-key-value-store" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Chapter 6. Design a key-value store | Denis&#x27; Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-key-value-store"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Chapter 6. Design a key-value store | Denis&#x27; Notes"><meta data-rh="true" name="description" content="Така започваме с дефиниция на KV store, това е nonrelational база данни, чиито освновни елементи са ключовете и стойностите. Всеки ключ е уникален и отговаря на една стойност. Тази семпла база ни позволява да държим, четем и пишем данни от памет, което я прави в пъти по-бърза от конвенционалните и persistent алтернативи."><meta data-rh="true" property="og:description" content="Така започваме с дефиниция на KV store, това е nonrelational база данни, чиито освновни елементи са ключовете и стойностите. Всеки ключ е уникален и отговаря на една стойност. Тази семпла база ни позволява да държим, четем и пишем данни от памет, което я прави в пъти по-бърза от конвенционалните и persistent алтернативи."><link data-rh="true" rel="icon" href="/notes/img/brackets.svg"><link data-rh="true" rel="canonical" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-key-value-store"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-key-value-store" hreflang="en"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-key-value-store" hreflang="x-default"><link rel="stylesheet" href="/notes/assets/css/styles.e478e7bb.css">
<script src="/notes/assets/js/runtime~main.941ee3d6.js" defer="defer"></script>
<script src="/notes/assets/js/main.3314736d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><b class="navbar__title text--truncate">Denis&#x27; Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/docs/intro">Denis&#x27; Documents</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/notes/docs/category/system-design-volume-1">System Design Volume 1</a><button aria-label="Collapse sidebar category &#x27;System Design Volume 1&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/scale-from-zero-to-millions-of-users">Chapter 1. Scale from zero to millions of users</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/back-of-the-envelope-estimation">Chapter 2. Back-of-the-envelope estimation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/framework-for-sys-design-interviews">Chapter 3. A framework for sys design interviews</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-rate-limiter">Chapter 4. Design rate limiter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-consistent-hashing">Chapter 5. Design Consistent Hashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/docs/system-design-vol-1/design-key-value-store">Chapter 6. Design a key-value store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-unique-id-generator-in-distributed-systems">Chapter 7. Design a unique ID generator in  Distributed systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-url-shortener">Chapter 8. Design a URL shortener</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-web-crawler">Chapter 9. Design a web crawler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-notification-system">Chapter 10. Design a notification system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-news-feed-system">Chapter 11. Design a news feed system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-chat-system">Chapter 12. Design a chat system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-search-autocomplete-system">Chapter 13. Design a search autocomplete system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-youtube">Chapter 14. Design YouTube</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-google-drive">Chapter 15. Design Google Drive</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/notes/docs/category/nodejs-design-patterns">Node.js Design Patterns</a><button aria-label="Expand sidebar category &#x27;Node.js Design Patterns&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notes/docs/category/system-design-volume-1"><span itemprop="name">System Design Volume 1</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Chapter 6. Design a key-value store</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Chapter 6. Design a key-value store</h1></header><p>Така започваме с дефиниция на KV store, това е nonrelational база данни, чиито освновни елементи са ключовете и стойностите. Всеки ключ е уникален и отговаря на една стойност. Тази семпла база ни позволява да държим, четем и пишем данни от памет, което я прави в пъти по-бърза от конвенционалните и persistent алтернативи.</p>
<p>Точно и в такива use cases бихме използвали KV store пред SQL база, за бърз обмен на данни, най-често на често използвани данни или на кратко бихме го използвали за cache.</p>
<p>Какво искаме от един КВ сторе:</p>
<ul>
<li>Да е бърз</li>
<li>Да има висок процент availability</li>
<li>Да може да се справя с голям брой заявки</li>
<li>Да може да се справя с голям размер данни</li>
<li>Да ни позволява да скалираме</li>
</ul>
<p>Първи опит да създадем КВ сторе би изглеждал по следният начин - Пускаме специален сървър, в който сме декларирали един hashmap (hashtable) и започваме да записваме и да четем стойности. Бързо разбираме, че нито можем да се справям с голям брой заявки, нито да се справяме с голям размер данни, нито можем да скалираме лесно, общо взето отговаряме само на изискването да сме бързи и то само понякога.</p>
<p>Започваме да дистрибутираме за да започнем да поправяме пропуските си. Първо ни трябва стратегия, за това се съобразяваме с CAP теоремата (Consistency, Availability, Partition Tolerance). Тя ни казва, че ние можем да гарантираме за нашият КВ сторе само две от тези три неща, като този факт теоритично ни дава три стратегии CA, AP &amp; CP. На практика имаме само две - AP &amp; CP - CA, тоест Consistency &amp; Availability е невъзможна стратегия в реалният свят, защото евентуалният partition e неизбежен, тоест не можем да сме и консистентни и на разположение 100% от времето. Разглеждаме останалите стратегии:</p>
<ul>
<li>CP - Consistency &amp; Partition Tolerance за сметка на Availability. Когато се появи partition между една инстанция на нашият сторе и останалите, всяка write &amp; последователна read операция води до неконсистентни данни, освен ако не заключим всички write операциите докато не преустановим връзката.</li>
<li>AP - Availability &amp; Partition Tolerance за сметка на Consistency. При установен partition, продължаваме работа както обикновено и приемаме възможността за неконсистентни данни, при условие, че имаме механизми, които синхронизират всички инстанции при преустановяване на връзката.
Според нашите нужди избираме едно от двете, ако сме банка бихме избрали CP, ако сме социална медия AP.</li>
</ul>
<p>Започваме да разглеждаме различните компоненти, които са нужни на нашата система.</p>
<p>Дистрибутирането на данните ни е неизбежно, просто сме сигурни, че физическият ресурс на една инстанция ще се изчерпа, за това завъртаме Н на брой инстанции, в които да рапределяме данните си. Връщаме се на миналата глава от която ще вземем идеята за consistent hashing и ще имплементираме в нашата дистрибутирана система, това ни позволява да скалираме автоматично и да се справяме с премахването на сървъри.</p>
<p>Следваща нужда, която трябва да покрием е това да имаме бекъпи на данните ни, това се случва, чрез репликация. Благодарение отново на consistent hashing можем да използваме hashing ring-a ни и вместо, когато избираме сървър за данните ни да избираме следващият сървър по посока часовниковата стрелка, избираме следващите Н сървъри, като Н е по наша преценка (Добре е те да са в различни дата центрове за да се защитим от физически проблеми).</p>
<hr>
<p>Вече сме установили дистрибутирането и репликирането на нашите данни и съответно имаме &quot;отговорници&quot; за отделни групи данни. За да установим и консистентност на нашите данни трябва да създадем кворум за писане и четене на данни. Кворум е колектив от decisionmakers, тоест представлява минималният брой реплики, които трябва да потвръдят, че една операцият е окей. Имаме Н на брой реплики, кворум за писане от В реплики и кворум за четене от Р реплики. Решенията се взимат на база нашата стратегия за консистентност, тя може да е силна, слаба и евентуална. При силната резултата от read операция връщаме задължително последната ъпдейтната стойност. При слабата при read операция нямаме задължителен достъп до последната ъпдейтната стойност. При евентуалната всички ъпдейти се препращат и след време тоест евентуално всички реплики са консистентни.</p>
<p>При неконсистентности между данните ние трябва да имаме подготвени механизми, които да ни помагат да се справяме с тях. Два са основните похвати, които можем да използваме. Единият е versioning на данните - на кратко всеки ъпдейт на определени данни се приема като отделни данни с инкрементирана версия. Това обаче не е достатъчно за да се справим с колизия, единственото, което ни позволява е да видим, че такава се е случила. В такъв случай използваме векторни часовници, това са вектори, които съдържат историята на единица данни, те съдържат всички направени промени от различните инстанции и техните версии. Те са последователни и е лесно да засечем дали една версия на данните е по-нова от друга или дали две версии са се променили независимо една от друга.</p>
<p>Ако една версия доминира друга (всички стойности в нейния вектор са по-големи или равни на тези в другата версия), то тя е по-новата и валидна версия. Ако обаче две версии имат несъвместими векторни часовници, тоест нито едната не доминира другата, това означава, че имаме конфликт. За разрешаването на конфликти можем да приложим автоматично сливане – комбинираме различните версии или други стратегии.</p>
<hr>
<p>Последното нещо, което трябва да направим е да предвидим случаите, в които определена инстация fail-не или не е на разположение. За да знаем дали една инстанция наистина не е на разположение не можем да разчитаме само на друга такава да обяви, че не е на разположение, трябва да имаме походящ механизъм или протокол, който да установява проблемите. Имплементираме така нареченият Gossip протокол, където всяка инстанция държи списък с ид-та на Н на брой други иснтанции и последният път, в който са получили сигнал от тях, така нареченият пулс. Всеки път когато един ноде получи сигнал той го предава на всички инстанции в списъка си. Когато никой не е получил сигнал за &quot;живот&quot; от една определена инстанция тя се флагва като failed или out of order. В такива случаи трябва да имаме готовност да се справим с този проблем. Първото нещо, което трябва да направим е да се погрижим да не блокираме системата, това може да се случи ако този отказ на инстанцията ни доведе до недостиг на acknowledgements в кворума ни, тогава ние използваме &quot;sloppy quorum&quot; и използваме първите R/W работещи инстанции, като делегираме отговорността на неработещият сървър на друг, като когато оправим проблема всички промени по временният &quot;отговорник&quot; се прехвърлят обратно. Превантивни мерки срещу постоянен failure на съврър е проток за консистентно синхронизиране на репликите, това се случва, чрез специален прокол, който създава Merkle дърво за всяка реплика и чрез него той сравнява къде има проблеми с консистентността.</p>
<p>Голям зор 😫</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/docs/system-design-vol-1/design-consistent-hashing"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 5. Design Consistent Hashing</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/docs/system-design-vol-1/design-unique-id-generator-in-distributed-systems"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 7. Design a unique ID generator in  Distributed systems</div></a></nav></div></div></div></div></main></div></div></div></div>
</body>
</html>