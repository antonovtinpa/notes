<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-system-design-vol-1/design-rate-limiter" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Chapter 4. Design rate limiter | Denis&#x27; Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-rate-limiter"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Chapter 4. Design rate limiter | Denis&#x27; Notes"><meta data-rh="true" name="description" content="Имаме задача да направи дизайн на rate limiter, първо трябва да се знае какво е РЛ и за какво е полезен. РЛ е част от архутектурата, която контролира трафика в контекста на уеб приложение контролира броят заявки, които се правят към сървъра."><meta data-rh="true" property="og:description" content="Имаме задача да направи дизайн на rate limiter, първо трябва да се знае какво е РЛ и за какво е полезен. РЛ е част от архутектурата, която контролира трафика в контекста на уеб приложение контролира броят заявки, които се правят към сървъра."><link data-rh="true" rel="icon" href="/notes/img/brackets.svg"><link data-rh="true" rel="canonical" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-rate-limiter"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-rate-limiter" hreflang="en"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-rate-limiter" hreflang="x-default"><link rel="stylesheet" href="/notes/assets/css/styles.e478e7bb.css">
<script src="/notes/assets/js/runtime~main.fdb653f9.js" defer="defer"></script>
<script src="/notes/assets/js/main.5615f779.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><b class="navbar__title text--truncate">Denis&#x27; Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/docs/intro">Denis&#x27; Documents</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/notes/docs/category/system-design-volume-1">System Design Volume 1</a><button aria-label="Collapse sidebar category &#x27;System Design Volume 1&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/scale-from-zero-to-millions-of-users">Chapter 1. Scale from zero to millions of users</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/back-of-the-envelope-estimation">Chapter 2. Back-of-the-envelope estimation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/framework-for-sys-design-interviews">Chapter 3. A framework for sys design interviews</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/docs/system-design-vol-1/design-rate-limiter">Chapter 4. Design rate limiter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-consistent-hashing">Chapter 5. Design Consistent Hashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-key-value-store">Chapter 6. Design a key-value store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-unique-id-generator-in-distributed-systems">Chapter 7. Design a unique ID generator in  Distributed systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-url-shortener">Chapter 8. Design a URL shortener</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-web-crawler">Chapter 9. Design a web crawler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-notification-system">Chapter 10. Design a notification system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-news-feed-system">Chapter 11. Design a news feed system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-chat-system">Chapter 12. Design a chat system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-search-autocomplete-system">Chapter 13. Design a search autocomplete system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-youtube">Chapter 14. Design YouTube</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-google-drive">Chapter 15. Design Google Drive</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/notes/docs/category/nodejs-design-patterns">Node.js Design Patterns</a><button aria-label="Expand sidebar category &#x27;Node.js Design Patterns&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notes/docs/category/system-design-volume-1"><span itemprop="name">System Design Volume 1</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Chapter 4. Design rate limiter</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Chapter 4. Design rate limiter</h1></header><p>Имаме задача да направи дизайн на rate limiter, първо трябва да се знае какво е РЛ и за какво е полезен. РЛ е част от архутектурата, която контролира трафика в контекста на уеб приложение контролира броят заявки, които се правят към сървъра.</p>
<p>Когато ни дадат тази задача първата стъпка според фреймуорка от миналта глава е да разберем какви са параметрите и изискванията. Започваме с това къде точно ще правим ограничението, на клиента или на сървъра, честно казано аз не съм чувал за рейт лимит от към клиента, най-вероятно защото не е много популчрно, самият автор казва, че няма как да имамe reliable рейт лимитинг на клиента, така че ще го имплементираме откъм сървъра. Втора стъпка, РЛ ще бъде интегриран в апито (апликацията) или ще бъде отделен сървиз, има плюсове и минуси за двата избора, авторът се спира на отделен сървиз, през който ще се минава преди да се пусне рекуеста към апито, ще служи като middleware (ако правим сравнително малка апликацията, без големи планове за скейлинг би било окей и да е част от монолит). Друго, което трябва да уточним е на база на какво ще лимитираме, на база имейл, ид, ип или други (аз лично съм правил рейт лимит само на база app info - имейл или ид). След като сме уточнили какви са изискванията авторът обобщата, правим РЛ като мидълуеър, целта ни е да е light weight, бърз, да се справя добре с грешки и след като е отделен сървиз да не бъде зависим от други компоненти в системата.</p>
<p>Втора стъпа е high level архитектура. Общо взето използваме изводите, до които сме стигнали от първа стъпка и започваме с избирането на алгоритъм за РЛ. Авторът дава пример за 5 алгоритма:</p>
<ul>
<li>Token bucket - Имаме едно място (бъкет), където държим определен брой токени (образно казано), на определено време презареждаме определен брой токени, при всяка заявка декрементираме броя токени с 1. Ако нямаме токени в бъкета рекуеста дропва. Тоест имаме един цикъл от декрементиране и инкрементиране на токени. Тука трудното е да се определят стойностите за големина на бъкетите и рефилинг процеса през колко време и по колко токена да се инкрементират.</li>
<li>Leaking bucket - При този алгоритъм имаме едно фифо кю (first in first out) от определен размер и от което се взимат заявки на определено време, когато стинем макс размер и получим заявка тя дропва. Тук също най-трудното е да се установят добри правила тоест размер на опашката и интервал за декю на заявки.</li>
<li>Fixed window counter - Тук разделяме timeline-а на определени времеви прозорци (еднакви) тоест можем да го разделим на 1,2,3,5 секунди, минута или каквото ни трябва на нас и в този интервал имаме каунтър от определен размер. За даден интервал от време можем да приемем Н на брой заявки, останалите дропват. Тук проблема се появява когато съберем повече заявки на границата между интервалите тоест да кажем искаме да обработваме 5 заявки на минута (минута, защото е по-лесно за описване) и влязат 5 между секунда 30 и секунда 59, на секунда 60 ние сме отворили още 5 места и в такъв случай то 00:30 до 01:30 ние можем да обработим 10 заявки, което не нашата цел.</li>
<li>Sliding window log - Този алгоритъм решава проблема на предишният като пази лог с timestamp-ове и когато влезе нова заявка проверява колко таймстампа има в определеният от нас интервал, тоест за интервал за интервал от 1 минута ако влезе заявка в 01:57 ние ще проверим логовете от 00:58 до сега, ако те са или надвишават определена бройка ние ще дропнем заявката, така избягваме проблема с границите. Тук проблемът е че изразхождаме много памет.</li>
<li>Sliding window count - Този алгоритъм е хибрид между двата предишни, честно казано не го разбрах напълно, имаме плаващ прозорец тоест не ни интересуват точни моменти на таймлайна, а Н на брой единици преди сегашният момент и вместо да пазим таймстампове пазим приблизителна стойност на броя заявки чрез някакво процентово калкулиране....
Който и алгоритъм да използваме ще използваме Редис за имплементацията, понеже ни продоставя ин мемори сторидж, тоест бърз ретривъл, плюс вградени функционалности като инкремент.</li>
</ul>
<p>Примерен флоу на системата би било - клиент прави рекуест, той минава през рейт лимитъра, прави се проверка на база правилата (правилата се записват на персистен диск, полват се от редиса на определен интервал от време) ако клиента е в рамките на лимита рекуеста се раутва към апито, изпълняваме съответната стъпка от алгоритма за да запишем, че сме приели рекуест, ако не е трябва да кажем на клиента, че е лимитиран. Това се клучва най-често чрез статус код 429 и къстъм хедъри.</p>
<p>Споменават се за проблеми, когато РЛ ни е в дистрибутирана система. Има проблеми с рейс кондишъни, когато приемеме заявки в почти едно и също време и резултата от първата не е готов, когато започнем да обработваме втората, можем да се справим с това чрез определена дата структура в Редис. Другият проблем е синхронизацията между отделни инстанции на РЛ, но просто можем да използваме централизиран сторидж.</p>
<p>От към перформънс можем винаги да се възползваме от различни геолокации за по-бърза връзка между различни клиенти.</p>
<p>Трябва да установим система за мониторинг за да проверяваме дали правилата и алгоритъмът ни са оптимални.</p>
<p>Нищо не помня от wrap up-a XD освен че могат да се направи рейт лимитър на друго ниво от оси модела освен на application layer-a, да кажем на база IP (network layer), не знам тука вече си говоря глупости.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/docs/system-design-vol-1/framework-for-sys-design-interviews"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 3. A framework for sys design interviews</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/docs/system-design-vol-1/design-consistent-hashing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 5. Design Consistent Hashing</div></a></nav></div></div></div></div></main></div></div></div></div>
</body>
</html>