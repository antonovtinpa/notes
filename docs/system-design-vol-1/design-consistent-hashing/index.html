<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-system-design-vol-1/design-consistent-hashing" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Chapter 5. Design Consistent Hashing | Denis&#x27; Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-consistent-hashing"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Chapter 5. Design Consistent Hashing | Denis&#x27; Notes"><meta data-rh="true" name="description" content="Преди да направим дизайн на consistent hashing първо разглеждаме защо е нужен и къде се използва. Разглеждаме хеширането като важен компонент при хоризонталното скалиране на база данни или така нареченият шардинг, връщаме се на първа глава за да обобщя какво представляваше процеса на шардинг - Имаме няколко ДБ сървъра или няколко бази, които споделят една и съща схема, но съдържат различни данни, като тези данни се разпределят между сървърите на база хеширащ алгоритърм, първо имаме ключ, който сами трябва да изберем, и който преминава през хешираща функция, която ни връща числена стойност, на тази числена стойност се прилага модулус от Н, където Н е броят на сървърите. Това е най-простият начин за шардинг -&gt; формулата е serverIndex = hashingFn(key) % N. Проблемът на този подход е че в случай, че един от сървърите фейлне или решим да увеличим броят на сървърите ние трябва да rehash-нем голяма част от ключовете поради факта че след като Н се промени повечето hashingFn(key) % N резултати ще се различават от оригиналните."><meta data-rh="true" property="og:description" content="Преди да направим дизайн на consistent hashing първо разглеждаме защо е нужен и къде се използва. Разглеждаме хеширането като важен компонент при хоризонталното скалиране на база данни или така нареченият шардинг, връщаме се на първа глава за да обобщя какво представляваше процеса на шардинг - Имаме няколко ДБ сървъра или няколко бази, които споделят една и съща схема, но съдържат различни данни, като тези данни се разпределят между сървърите на база хеширащ алгоритърм, първо имаме ключ, който сами трябва да изберем, и който преминава през хешираща функция, която ни връща числена стойност, на тази числена стойност се прилага модулус от Н, където Н е броят на сървърите. Това е най-простият начин за шардинг -&gt; формулата е serverIndex = hashingFn(key) % N. Проблемът на този подход е че в случай, че един от сървърите фейлне или решим да увеличим броят на сървърите ние трябва да rehash-нем голяма част от ключовете поради факта че след като Н се промени повечето hashingFn(key) % N резултати ще се различават от оригиналните."><link data-rh="true" rel="icon" href="/notes/img/brackets.svg"><link data-rh="true" rel="canonical" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-consistent-hashing"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-consistent-hashing" hreflang="en"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-consistent-hashing" hreflang="x-default"><link rel="stylesheet" href="/notes/assets/css/styles.e478e7bb.css">
<script src="/notes/assets/js/runtime~main.87a756f5.js" defer="defer"></script>
<script src="/notes/assets/js/main.9e7a53ef.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><b class="navbar__title text--truncate">Denis&#x27; Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/docs/intro">Denis&#x27; Documents</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/notes/docs/category/system-design-volume-1">System Design Volume 1</a><button aria-label="Collapse sidebar category &#x27;System Design Volume 1&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/scale-from-zero-to-millions-of-users">Chapter 1. Scale from zero to millions of users</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/back-of-the-envelope-estimation">Chapter 2. Back-of-the-envelope estimation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/framework-for-sys-design-interviews">Chapter 3. A framework for sys design interviews</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-rate-limiter">Chapter 4. Design rate limiter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/docs/system-design-vol-1/design-consistent-hashing">Chapter 5. Design Consistent Hashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-key-value-store">Chapter 6. Design a key-value store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-unique-id-generator-in-distributed-systems">Chapter 7. Design a unique ID generator in  Distributed systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-url-shortener">Chapter 8. Design a URL shortener</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-web-crawler">Chapter 9. Design a web crawler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-notification-system">Chapter 10. Design a notification system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-news-feed-system">Chapter 11. Design a news feed system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-chat-system">Chapter 12. Design a chat system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-search-autocomplete-system">Chapter 13. Design a search autocomplete system</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notes/docs/category/system-design-volume-1"><span itemprop="name">System Design Volume 1</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Chapter 5. Design Consistent Hashing</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Chapter 5. Design Consistent Hashing</h1></header><p>Преди да направим дизайн на consistent hashing първо разглеждаме защо е нужен и къде се използва. Разглеждаме хеширането като важен компонент при хоризонталното скалиране на база данни или така нареченият шардинг, връщаме се на първа глава за да обобщя какво представляваше процеса на шардинг - Имаме няколко ДБ сървъра или няколко бази, които споделят една и съща схема, но съдържат различни данни, като тези данни се разпределят между сървърите на база хеширащ алгоритърм, първо имаме ключ, който сами трябва да изберем, и който преминава през хешираща функция, която ни връща числена стойност, на тази числена стойност се прилага модулус от Н, където Н е броят на сървърите. Това е най-простият начин за шардинг -&gt; формулата е serverIndex = hashingFn(key) % N. Проблемът на този подход е че в случай, че един от сървърите фейлне или решим да увеличим броят на сървърите ние трябва да rehash-нем голяма част от ключовете поради факта че след като Н се промени повечето hashingFn(key) % N резултати ще се различават от оригиналните.</p>
<p>Тук се намесва consistent hashing, това е подход, при който &quot;изграждаме&quot; hashing space, който се състои от всички възможни output-и от хеширащата функция. На база това хеширано пространство &quot;изграждаме&quot; hashing ring, който се получава, когато &quot;съединим&quot; началото и края на хешираното пространство. Следваща стъпка е да &quot;заложим&quot; нашите сървъри върху пръстена, като просто пуснем тяхното ИП или някакво ИД през хеширащата функция и ги поставим в съответният слот. След като имаме пръстена и сървърите върху него вече можем да инсертваме данни, това случва по следният начин - хешираме ключа и търсим слота му върху пръстена, след като го намерим започваме да обхождаме пръстена по посока часовниковата стрелка докато не намерим сървър, данните се записват в първият намерен съръвър. По този начин дори и да премахнем или добавим сървър ние средно трябва да рехешираме К/Н броя ключа като К е общият брой ключове а Н е общият брой слотове.</p>
<p>Има обаче два основни проблема с този подход на този етап.</p>
<ol>
<li>Напълно възможно е един сървър да съдържа пъти в повече данни от друг поради начин, по който се дистрибутират ключовете</li>
<li>Също е напълно възможно един сървър да покрива в пъти по-голям интервал върху пръстена от други
Решението е да използваме virtual nodes, това са един вид &quot;дистрибутори&quot; на сървъра (реалният ноуд), те са разпределени върху пръстена, като те са много на брой 100, 150, 200 за всеки съръвър и са равномерно разпределени върху пръстена. Намирането на сървър пак се случва по посока на часовниковата стрелка просто когато срещнем витруален ноуд ние реферираме към сървъра. Правя аналогия с интегралите, в смисъла на броят ВНоудове, стига да имаме достатъчен брой малки правоъгълници под функцията, ние можем да намерим приблизителното лице.</li>
</ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/docs/system-design-vol-1/design-rate-limiter"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 4. Design rate limiter</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/docs/system-design-vol-1/design-key-value-store"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 6. Design a key-value store</div></a></nav></div></div></div></div></main></div></div></div></div>
</body>
</html>