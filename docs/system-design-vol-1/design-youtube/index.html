<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-system-design-vol-1/design-youtube" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Chapter 14. Design YouTube | Denis&#x27; Notes</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-youtube"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Chapter 14. Design YouTube | Denis&#x27; Notes"><meta data-rh="true" name="description" content="Така правим дизайн на YouTube XDDD от AliExpress. Имаме следните изисквания:"><meta data-rh="true" property="og:description" content="Така правим дизайн на YouTube XDDD от AliExpress. Имаме следните изисквания:"><link data-rh="true" rel="icon" href="/notes/img/brackets.svg"><link data-rh="true" rel="canonical" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-youtube"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-youtube" hreflang="en"><link data-rh="true" rel="alternate" href="https://antonovtinpa.github.io/notes/docs/system-design-vol-1/design-youtube" hreflang="x-default"><link rel="stylesheet" href="/notes/assets/css/styles.e478e7bb.css">
<script src="/notes/assets/js/runtime~main.941ee3d6.js" defer="defer"></script>
<script src="/notes/assets/js/main.3314736d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes/"><b class="navbar__title text--truncate">Denis&#x27; Notes</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes/docs/intro">Documents</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes/docs/intro">Denis&#x27; Documents</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/notes/docs/category/system-design-volume-1">System Design Volume 1</a><button aria-label="Collapse sidebar category &#x27;System Design Volume 1&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/scale-from-zero-to-millions-of-users">Chapter 1. Scale from zero to millions of users</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/back-of-the-envelope-estimation">Chapter 2. Back-of-the-envelope estimation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/framework-for-sys-design-interviews">Chapter 3. A framework for sys design interviews</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-rate-limiter">Chapter 4. Design rate limiter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-consistent-hashing">Chapter 5. Design Consistent Hashing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-key-value-store">Chapter 6. Design a key-value store</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-unique-id-generator-in-distributed-systems">Chapter 7. Design a unique ID generator in  Distributed systems</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-url-shortener">Chapter 8. Design a URL shortener</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-web-crawler">Chapter 9. Design a web crawler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-notification-system">Chapter 10. Design a notification system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-news-feed-system">Chapter 11. Design a news feed system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-chat-system">Chapter 12. Design a chat system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-search-autocomplete-system">Chapter 13. Design a search autocomplete system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes/docs/system-design-vol-1/design-youtube">Chapter 14. Design YouTube</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes/docs/system-design-vol-1/design-google-drive">Chapter 15. Design Google Drive</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/notes/docs/category/nodejs-design-patterns">Node.js Design Patterns</a><button aria-label="Expand sidebar category &#x27;Node.js Design Patterns&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/notes/docs/category/system-design-volume-1"><span itemprop="name">System Design Volume 1</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Chapter 14. Design YouTube</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Chapter 14. Design YouTube</h1></header><p>Така правим дизайн на YouTube XDDD от AliExpress. Имаме следните изисквания:</p>
<ul>
<li>Имаме два основни feature-a да качваме видеа и да гледаме видеа</li>
<li>Трябва да поддържаме различни устройства web, mobile &amp; smart TV</li>
<li>Ще имаме 5М DAU</li>
<li>Трябва да сме на международният пазар</li>
<li>Трябва да поддържаме повечето познати видео формати в различни резолюции</li>
<li>BOE Анализ:<!-- -->
<ul>
<li>Преполагаме, че всеки потребител би гледал по 5 видеа на ден</li>
<li>Преполагаме, че средно размерът на едно видео е 300MB</li>
<li>Преполагаме, че средно един CDN би ни таксувал 2 цента / 1GB трафик</li>
<li>Предполагаме, че 10% от потребителите в даден ден качват видео</li>
<li>Тоест от към пространство ще имаме нужда от 5М _ 0.1 _ 300 = 150TB ежедневно</li>
<li>Тоест от към финансов ресурс ще имаме нужда от 5М _ 5 _ 0.3 * 0.02 = 150 000 USD всеки ден</li>
</ul>
</li>
</ul>
<p>Този анализ ни покзва слабите ни места и в последствие частите, които бихме искали да оптимизираме.</p>
<p>Започваме с изграждане на основите, не знам, нека започнем по модули/компоненти:</p>
<ol>
<li>Клиентите са ясни, те комуникрат желанията на потребителя към API-то.</li>
<li>API Server - Това ни е задължителният дистрибутиран сървър, всички инстанции седят зад Load Balancer, as usual. Тук ще се случва аутентикацията и ауторизацията, също ще извършваме координационна дейност, като изпращане на събщения към Message Queue-та, генериране на pre-signed URL-и други.</li>
<li>Original Storage - Това ще е BLOB storage, който ще пази видеата на потребителите в оригиналният им формат. Реално погледнато в цялата глава се споменава AWS терминология така че най-вероятно ще е S3.</li>
<li>Transcoding Service - Това може би е най-сложната част от цялата система, тук ще encode-ваме видеата в различни формати и резолюции. Това трябва да се случи поради факта, че когато снимаме едно видео, то се запазва под определен формат и с определени качества като bit rate, FPS, резолюция и други. Проблемът е, че не всяко устройство поддържа всички формати и не винаги bandwidth-а на една интернет връзка може да поддържа определен bit rate. В такива ситуации ние искаме да сме адаптивни и да предоставим най-добрият user experience на потребителя, като намалим динамично намалим качеството на видеото повреме на стрийм за да не забива.</li>
<li>Encoded Storage - Това ще е отделен storage, който ще пази вече encode-натите видеа.</li>
<li>Metadata Database - Това ще базаданни, в която ще събираме мета данни за определено видео, име, големина, продължителност, автор, екстеншън, брой на чънкове и така нататък.</li>
<li>Metadata Cache - Тук ще кешираме мета данните на популярни видеа, а може и да е някакъв LRU кеш, понеже очакваме, че по-новите видеа ще бъдат по-популярни.</li>
<li>CDN - Ами CDN-ите ще бъдат MVP-то на нашият продукт, целта ни е след всеки ъплоуд да качваме енкоднатите видеа в CDN-ите за да се възползваме от сервиране не видеа по геолокация. Видеата ще се стриймват директно от CDN-а.</li>
</ol>
<p>Общо взето така изглежда системата на високо ниво. Сега е време да разгледаме как работи Transcoding Service-а. Сам по себе си Transcoding Service-а се дели на различни компоненти:</p>
<ol>
<li>Preprocessor - Този модул има за задача да раздели едно видео на множество чънкове или така наречените GOP (Group of Pictures), по този начин ние можем да продължим енкоудването на видето като паралелно се обработват различните чънкове, също така ако един чък фейлне ние просто можем да retry-нем само него. Също така тук се генрира и DAG-а (Directed Acyclical Graph).<!-- -->
<ul>
<li>DAG model-a е нещо взаимствано от Facebook и общо взето представлява карта за това по какъв начин да се изпълнят определени действия, било то в последователност или паралелно. <em>Аналогия от истинският живот би било, като се намираш в Плевен и искаш да стигнеш до София да си избереш динамично маршрута в Google Maps, според нуждите ти</em>. Тоест ако имаме видео, към което потребителя е прикачил thumbnail, ние да направим маршрут, който включва записването на thumbnail-a.</li>
</ul>
</li>
<li>DAG scheduler - Този модул взима DAG-а и разпределя таскове поетапно според това дали могат да се случват паралелно или последователно. Тези таскове се пазят в определено Task Queue.</li>
<li>Task Workers - Това е pool от worker-и, които ще изпълняват тасковете, които им назначим.</li>
<li>Running Queue - Тука ще пазим тасковете, които се изпълняват в момента, заедно в worker-а, който ги изпълнява.</li>
<li>Resource Manager - Това е нашият координатор, той върши следните неща:<!-- -->
<ol>
<li>Периодично проверява task queue-то и взима най-приоритетните</li>
<li>От task worker queue намира подходящ worker за текущият таск и му го назначава</li>
<li>Записва таска и работника в running queue-то</li>
<li>Веднъж щом таска е готов го премахва от рънинг кюто и освобождава работника</li>
</ol>
</li>
</ol>
<ul>
<li>Може би споменах някои от реалните таскове, които трябва да се извършат, но се опасявам, че ми липсва domain knowledge за да кажа точно какво трябва да се случи. Трябва да се направят encoding-ите, да се запишат thumbnail-ите да се събере метадата и да се запише във временен storage. Идеята е, че в момента, в който сме готови обработените видеа се запазват и разпределят по CDN-ите и метдатата се записва.</li>
</ul>
<p>Общо взето е това, сега трябва да отделим известно време на оптимизации. Първо нека започнем с опит да установим по-ефективни процеси. В момента имаме някакъв последователен процес - Качване на файл -&gt; Енкоуване на оригиналният файл -&gt; Качване на енкоудинга -&gt; Прехвърляне към CDN-a - Ами всичко това могат да са отделни модули, които си комуникират, чрез message queue-та, не се блокират и използваме максимално ресурса си. Другото нещо, което можем да направим е да се възползваме от CDN-ите и да усновим центрове за качване на видеа на стратегически геолокации.
От към сигурност, аз го споменах това, но можем да изградим flow за качване на видеа, чрез pre-signed URL-и, тоест клиента ще заяви на сървъра, че ще качва файл, той създава обект в S3 и връща URL-a с определен expiration date, клиента от там нататък използва УРЛ-а за да качи файла. Другото нещо е да имплементираме някакъв вид encryption (AES, нещо си, не помня) и да използваме някаква система за модериране на сидържание от неподходящ характер като насилие, NSFW съдържание, наредно използване на интелектуална собственост и др. Последната оптимизация би ни била да си спестим някой разход като вместо да кешираме всички видеа в CDN-ите просто запазваме най-популярните, а останлите запазваме и сервираме, чрез dedicated servers.</p>
<p>В wrap up-a можем да обсъдим каква база ще използваме и как ще я скалираме. До колкото прочетох, най-удачно е използваме NoSQL база данни поради факта, че най-вероятно ще имаме ненормализирани данни, които вървят срещу природата на релационните бази данни. Можем да скалираме хоризонтално, тоест да шарднем базата по video ID. Можем да дистрибутираме сървърите в отделни дата центрове по света, имайки предвид, че сме на международният пазар.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes/docs/system-design-vol-1/design-search-autocomplete-system"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 13. Design a search autocomplete system</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes/docs/system-design-vol-1/design-google-drive"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 15. Design Google Drive</div></a></nav></div></div></div></div></main></div></div></div></div>
</body>
</html>